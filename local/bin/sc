#!/bin/bash

set -- $(getopt -o f:shi -l file:,start,stop,info,help -- "$@")

display_help() {
  cat << 'EOF'
'screencast' - Screen recording with ffmpeg.

Usage:
  sc [OPTIONS]

Options:
  --start               Start the screencast. Pair with --file.

  --stop                Kills all ffmpeg processes.

  -f, --file <name>     Passes the filename for the screencast. Pair with --start.
                        <name> should be video format like .mp4 or .mkv and so on.

  -i, --info            Display info about current recording.

  --help, -h            Display this help.

EOF
}

start_recording () {

  if [ -z ${filename} ]; then
    echo "sc: Filename missing."
    echo "Try '--help' for usage information."
    exit 1
  fi

  output="${SCREENCAST_OUTPUT_DIR}/${filename}"
  resolution=$(xrandr | awk '/\*/ {print $1}')
  sink="$(pactl info | grep 'Default Sink' | awk '{print $3}').monitor"
  source="$(pactl info | grep 'Default Source' | awk '{print $3}')"

  date +%s > /tmp/screencast.starttime
  echo title=${filename} >> /tmp/screencast.info
  echo resolution=${resolution} >> /tmp/screencast.info
  echo output=${output} >> /tmp/screencast.info
  echo sink=${sink} >> /tmp/screencast.info
  echo source=${source} >> /tmp/screencast.info

  ffmpeg -f x11grab -r 30 -s ${resolution} -i :0.0 -f pulse -i "${sink}" \
    -map 0:v -map 1:a -c:v libx264 -preset ultrafast -c:a aac \
    ${output} -hide_banner -loglevel error &

  echo Recording in progress 
}

stop_recording () {
  if pgrep ffmpeg &> /dev/null; then
    pkill ffmpeg
    rm /tmp/screencast.info
    rm /tmp/screencast.starttime
    echo Recording stopped
  else 
    echo Nothing to stop
    exit 1
  fi
}

### main

SCREENCAST_OUTPUT_DIR="/home/$USER/Videos/screencasts"

if [ ! -d ${SCREENCAST_OUTPUT_DIR} ]; then
  mkdir -p ${SCREENCAST_OUTPUT_DIR}
fi

declare filename 
declare rec 

while [ -n "$1" ]
do 
  case $1 in
    --start) 
      rec="start"
      shift
      ;;

    -s|--stop) 
      rec="stop"
      shift 
      ;;

    -i|--info) 
      if [ -f /tmp/screencast.info ]; then
        cat /tmp/screencast.info
        start_time=$(cat /tmp/screencast.starttime)
        now=$(date +%s)
        elapsed=$(( now - start_time ))
        echo 
        printf "elapsed time: %02d:%02d:%02d\n" \
          $((elapsed / 3600)) \
          $(((elapsed % 3600) / 60)) \
          $((elapsed % 60))
      else
        echo Nothing to show.
        exit 1
      fi
      shift
      ;;

    -f|--file) 
      filename="${2//[\"\']/}"
      shift 2
      ;;

    -h|--help) 
      display_help
      shift
      exit 1
      ;;

    --) shift ;;

    *) 
      echo "Try '--help' for usage information."
      exit 1
      ;;
  esac
done

case "$rec" in
  start) start_recording ;;
  stop) stop_recording ;;
esac
