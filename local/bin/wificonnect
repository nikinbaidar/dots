#!/bin/bash

display_help() {
    echo "Connect network (WiFi)"
    echo
    echo "  --connect Activate an existing connection."
    echo "  --new     Create a new connection."
    echo "  -h        Display this help."
}

case $1 in 
  "-n"|"--new")
    nmcli device wifi rescan
    sleep 2
    SSID="$(nmcli -f SSID device wifi list | tail -n +2 | grep --invert-match "^--" | sort -t: -k2 -nr | cut -d: -f1 | fzf)"
    SSID="${SSID%"${SSID##*[![:space:]]}"}"
    if [ -n "${SSID}" ]; then
        echo "    SSID: ${SSID}"
        read -s -p "Password: " PASSWORD
        if ! nmcli device wifi connect "${SSID}" password "${PASSWORD}"; then
            echo Failed to connect to '${SSID}'
            echo "nmcli device wifi connect " | xclip -sel clipboard -i
        fi
    fi
    ;;

"--connect")
    SSID=$(nmcli -f NAME con | tail -n +2 | grep --invert-match "^lo" | fzf)
    if [ -n "${SSID}" ]; then
        nmcli con up ${SSID}
    fi
    ;;

"-i"|"-s"|"--info"|"--stat")
    echo Connected to \'$(nmcli -t -f NAME connection show --active | head -1)\'
    ;;
*)
    display_help
    exit 1
    ;;
esac
