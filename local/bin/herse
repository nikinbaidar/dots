#!/usr/bin/env bash

function display_setup_info() {
    echo If you\'re starting jupyter-lab within a conda env don\'t forget to update the \`jupyter kernelspec list\`.
    echo "Run \`python -m ipykernel install --user --name=env --display-name \"Python 3.X\"\`" outside the `env`.
    echo "Then select the appropriate kernel in jupyter-notebook"
    echo
}

if [[ "${1}" = "-h" || "${1}" = "--help" ]]
then
    display_setup_info
    exit 0
fi

rm -rf /tmp/jpserver.logs

jupyter-lab --no-browser &> /tmp/jpserver.logs &

MAX_WAIT_TIME=30
start_time=$(date +%s)

while true
do
    current_time=$(date +%s)
    elapsed_time=$((current_time - start_time))

    # Check if the elapsed time has exceeded the maximum wait time
    if [ "$elapsed_time" -ge "$MAX_WAIT_TIME" ]; then
        echo "Timeout reached. Jupyter Server did not start in 30 seconds."
        exit 1
    fi

    sleep 3

    url=$(grep -m 1 '^[[:space:]]*file' /tmp/jpserver.logs | sed 's/^[[:space:]]*//')

    if [ -n "${url}" ]; then
        echo \'${url}\'
        surf ${url} &> /dev/null &
        break
    fi
done
