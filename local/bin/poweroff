#!/bin/bash

function pushNotes() {
    pushd ~/notes
    branch=$(git branch | awk ' /\*/ {print $2} ')
    if [ -n "$(git status -s)" ]; then
        git pull
        git add --all
        git commit -m "o.O"
        git push -u origin ${branch} --verbose
    else
        echo "nothing to commit, working tree clean"
    fi
    popd > /dev/null
}

function waitForDropbox() {
    local start=$(date +%s)
    local TIMEOUT=120 # Seconds
    while [ "$(dropbox-cli status)" != "Up to date" ]; do
        sleep 1
        local now=$(date +%s)
        local elapsed=$((now - start))
        if [ "${elapsed}" -ge "${TIMEOUT}" ]; then
            return 1  # timeout
        fi
    done
    echo "Up to date."
    return 0
}

function pushDropbox() {
    dropbox-cli start > /dev/null 2>&1
    if [ "$(dropbox-cli status)" = "Up to date" ]; then
        echo "Up to date."
    else
        echo "Synchronization in progress..."
        if ! waitForDropbox; then
            dropbox-cli update
            if ! waitForDropbox ; then
                echo "Dropbox did not sync."
                echo "Press any key to shutdown now."
                read x
                exit 1
            fi
        fi
        dropbox-cli stop
    fi
}

if ping -c 1 google.com 1> /dev/null || ping -c 1 reddit.com 1> /dev/null
then
    pushNotes
    pushDropbox
else
    echo "No intenet"
    exit 0
fi

shutdown now


