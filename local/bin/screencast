#!/bin/bash

set -- $(getopt -o b:m:siprh -l begin:,mode:,stop,pause,resume,info,help -- "$@")

display_help() {
  cat << 'EOF'
'sc' - Screen recording with ffmpeg.

Usage:
  sc [OPTIONS]

Options:
  -b, --begin <file>    Start the screencast. <file> must be a video format.
                        If an extension is not provided '.mp4' will be used.

  -h, --help            Display this help.

  -i, --info            Display info about current recording.

  -m, --mode            Set recording mode.
                        '0' Record the screen and the sink (default) 
                        '1' Record screen, sink and input.

  -p, --pause           Pause an ongoing recording.

  -r, --resume          Resume a paused recording.

  -s, --stop            Kill all ffmpeg processes.

EOF
}


start_recording () {
  if [ -z "${filename}" ]; then
    echo "Filename not specified. Aborting..."
    exit 1
  fi

  if [[ "$(basename -- "$filename")" != *.* ]]; then
    echo "No file extension specified; using default '.mp4'."
    filename="${filename}.mp4"
  fi

  output="${SCREENCAST_DIR}/${filename}"

  if [ -f ${output} ]; then
    read -r -p "${output} is an existing file. Do you wish to overwrite it? [y/N]? " answer
    case "$answer" in
      [yY]) ;;
      *) exit 1;;
    esac
  fi

  resolution=$(xrandr | awk '/\*/ {print $1}')
  sink="$(pactl info | grep 'Default Sink' | awk '{print $3}').monitor"

  if [ -d ${metadata} ]; then
    msg="Recording resumed"
  else
    mkdir -p ${metadata}
    msg="Recording started"
  fi

  date +%s > ${metadata}/starttime
  echo title=${filename} > ${metadata}/info
  echo resolution=${resolution} >> ${metadata}/info
  echo filepath=${output} >> ${metadata}/info
  echo sink=${sink} >> ${metadata}/info

  if [[ $mode = 1 ]]; then
    # Grabs screen, sink and source
    source="$(pactl info | grep 'Default Source' | awk '{print $3}')"
    echo source=${source} >> ${metadata}/info
    ffmpeg -y -f x11grab -r 30 -s ${resolution} -i :0.0 -f pulse -i "${source}" \
      -f pulse -i "${sink}" -filter_complex "[1:a][2:a]amerge=inputs=2[a]" \
      -map 0:v -map "[a]" -c:v libx264 -preset ultrafast -c:a aac -strict experimental \ 
      ${output} -hide_banner -loglevel error &
  else
    # Screen and sink no source (mic)
    ffmpeg -y -f x11grab -r 30 -s ${resolution} -i :0.0 -f pulse -i "${sink}" \
      -map 0:v -map 1:a -c:v libx264 -preset ultrafast -c:a aac \
      ${output} -hide_banner -loglevel error &
  fi

  echo $msg
}


pause_recording() {
  if [[ -d "$metadata" ]] && pgrep ffmpeg > /dev/null; then
    pkill ffmpeg
    echo paused=true >> $metadata/info
    echo "Recording paused"
  else
    echo "Nothing to pause"
    exit 1
  fi
}


resume_recording() {
  if [[ -d "$metadata" ]] && grep -q paused=true ${metadata}/info; then
    fp=$(grep filepath ${metadata}/info | cut -d '=' -f 2)
    echo ${fp} >> ${metadata}/mergelist.txt
    filename="$(grep title= ${metadata}/info | cut -d '=' -f 2 | cut -d. -f1)_$(date +'%s').mp4"
    start_recording # again
  else
    echo "Nothing to resume"
    exit 1
  fi
}


stop_recording () {
  if pgrep ffmpeg &> /dev/null; then
    pkill ffmpeg
    echo Recording stopped
  fi 

  if [ -f ${metadata}/mergelist.txt ]; then
    fp=$(grep filepath ${metadata}/info | cut -d '=' -f 2)
    echo ${fp} >> ${metadata}/mergelist.txt
    sed -i "s|^|file '|; s|$|'|" ${metadata}/mergelist.txt
    fp="${SCREENCAST_DIR}/final_$(date +'%s').mp4"
    if ffmpeg -f concat -safe 0 -i ${metadata}/mergelist.txt -c copy "${fp}" -hide_banner -loglevel error; then
      filename=$(head -1 ${metadata}/mergelist.txt | cut -d ' ' -f 2)
      filename="${filename//[\"\']/}"
      sed 's/^file/rm/g' ${metadata}/mergelist.txt | bash
      mv ${fp} ${filename}
      echo Recording finished
    else 
      echo Concatnating files with ffmpeg has failed. May require manual intervention.
      exit 1
    fi
  fi

  if [ -d ${metadata} ]; then
    rm -r ${metadata}
  else
    echo "Nothing to stop"
  fi

}


recording_status() {
  if [ -d ${metadata} ]; then
    cat ${metadata}/info
    if [ -f ${metadata}/mergelist.txt ]; then
      echo
      echo --- MERGE LIST ---
      nl ${metadata}/mergelist.txt
    fi
  else
    echo Nothing to show
    exit 1
  fi

}


SCREENCAST_DIR="$HOME/Videos/screencasts"
metadata="/tmp/screencast.$USER"

if [ ! -d ${SCREENCAST_DIR} ]; then
  mkdir -p ${SCREENCAST_DIR}
fi

while [ -n "$1" ]
do 
  case $1 in
    -b|--begin) 
      filename="${2//[\"\']/}"
      mode=0
      shift 2
      start_recording 
      ;;

    -s|--stop) 
      shift 
      stop_recording 
      ;;

    -p|--pause) 
      shift 
      pause_recording
      ;;

    -r|--resume) 
      shift 
      resume_recording
      ;;

    -i|--info) 
      shift
      recording_status
      ;;

    -h|--help) 
      shift
      display_help
      exit 1
      ;;

    --) shift ;;

    *) 
      display_help
      exit 1
      ;;
  esac
done
