#!/bin/bash

source ${DOTS}/shell/prompt_colors

SCREENCAST_DIR="${HOME}/Videos/screencasts"

function display_help() {
    echo "Usage: $0 [OPTION]"
    echo "Options:"
    echo "    --start   Start screen recording."
    echo "    --stop    Stop screen recording."
    echo "    --watch   Watch the latest screencast."
}

function start() {
    echo -n "Enter screencast name: "; read x
    output="${SCREENCAST_DIR}/${x}$(date +'%y%m%d%H%M%S').mp4"
    default_sink=$(pactl info | grep "Default Sink" | awk '{print $3}')
    default_source=$(pactl info | grep "Default Source" | awk '{print $3}')

    echo "1" > /tmp/recording.txt

    ffmpeg -f x11grab -r 30 -s 1366x768 -i :0.0 -f pulse -i ${default_source} -f pulse -i ${default_sink}.monitor -filter_complex "[1:a][2:a]amerge=inputs=2[a]" -map 0:v -map "[a]" -c:v libx264 -preset ultrafast -c:a aac -strict experimental ${output} -hide_banner -loglevel quiet &
}

function watch() {
    output=$(ls -t ${SCREENCAST_DIR} | head -n 1)
    echo -en "The latest screencast is '${output}'.nWould you like to watch it? [N/y] "
    read answer
    case "$answer" in
        [yY])
            mpv ${SCREENCAST_DIR}/${output} ;;
        *)
            exit 0 ;;
    esac
}

function mute() {
    default_source=$(pactl info | grep "Default Source" | awk '{print $3}')
    pactl set-source-mute "${default_source}" 1
    echo "mute" > /tmp/muted
}

function unmute() {
    default_source=$(pactl info | grep "Default Source" | awk '{print $3}')
    pactl set-source-mute "${default_source}" 0
    rm /tmp/muted
}


if [[ "$1" = "--start" ]]; then
    start
elif [[ "$1" = "--stop" ]]; then
    pkill ffmpeg
    rm /tmp/recording.txt
elif [[ "$1" = "--watch" ]]; then
    watch
elif [[ "$1" = "--mute" ]]; then
    mute
elif [[ "$1" = "--unmute" ]]; then
    unmute
else
    display_help
    exit 0;
fi
